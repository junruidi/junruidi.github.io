X = cbind(1,as.matrix(dat.test[,1:6]))
X.des = X
X = kronecker(X.des, Theta)
gls_mod = mod.fld$model.gls
S = chol(solve(mod.fld$sigma))
T = S %*% Theta
M = kronecker(X.des, T)
dim(M)
k
8*!44
8*144
dim(X.des)
7 * 8
56 * 33
56 * 32
xx = predict(gls_mod, newdata = M)
rm(list = ls())
setwd("~/Dropbox/Junrui Di/BLSA FOSR MRI/")
load("data/analysis/bv.rda")
library(refund)
library(caret)
for(i in 3:12){
bv[,i] = log(bv[,i]/bv$icv70)
}
bv$icv70 =  NULL
bv[,c(2:12,15:16)] = scale(bv[,c(2:12,15:16)])
rm(list = setdiff(ls(),c("act_ave","bv")))
act_ave$ID = NULL
act_ave = as.matrix(act_ave)
roi = names(bv)[2:11]
i = 1
roi.i = roi[i]
bv.i = subset(bv, select = c("gender","race","Age","educ_years","CESD",roi.i))
k = 8
dat.ave = bv.i
dat.ave$Y = act_ave
vars = names(dat.ave)[-7]
formula(paste0("Y ~ ", paste(vars, collapse = "+")))
mod.fld = gls_cs(formula(paste0("Y ~ ", paste(vars, collapse = "+"))), data = dat.ave, basis = "pbs", Kt = k,CI.type = "pointwise")
y = dat.ave$Y
X = cbind(1,as.matrix(dat.ave[,1:6]))
b = mod.fld$beta.hat
y = dat.ave$Y
X = cbind(1,as.matrix(dat.ave[,1:6]))
b = mod.fld$beta.hat
yhat = X %*% b
rm(list = ls())
setwd("~/Dropbox/Junrui Di/BLSA FOSR MRI/")
load("data/analysis/bv.rda")
library(refund)
library(caret)
for(i in 3:12){
bv[,i] = log(bv[,i]/bv$icv70)
}
bv$icv70 =  NULL
bv[,c(2:12,15:16)] = scale(bv[,c(2:12,15:16)])
rm(list = setdiff(ls(),c("act_ave","bv")))
act_ave$ID = NULL
act_ave = as.matrix(act_ave)
roi = names(bv)[2:11]
R2 = data.frame()
for(i in 1:10){
roi.i = roi[i]
bv.i = subset(bv, select = c("gender","race","Age","educ_years","CESD",roi.i))
k = 8
dat.ave = bv.i
dat.ave$Y = act_ave
vars = names(dat.ave)[-7]
mod.fld = gls_cs(formula(paste0("Y ~ ", paste(vars, collapse = "+"))), data = dat.ave, basis = "pbs", Kt = k,CI.type = "pointwise")
y = dat.ave$Y
X = cbind(1,as.matrix(dat.ave[,1:6]))
b = mod.fld$beta.hat
yhat = X %*% b
sst = colSums(scale(y, scale = F)^2)
ybar = colMeans(y)
ssre =colSums((yhat - t(replicate(dim(y)[1],ybar)))^2)
R2 = rbind(R2,ssre/sst)
}
View(bv.i)
View(R2)
par(mfrow = c(6,1))
for(i in 1:6){plot(R2[1,], type = "l", ylim = c(0,1))}
for(i in 1:6){plot(c(t(R2[,1])), type = "l", ylim = c(0,1))}
par(mfrow = c(3,1))
for(i in 1:6){plot(c(t(R2[,1])), type = "l", ylim = c(0,1))}
rm(list = ls())
setwd("~/Dropbox/Junrui Di/BLSA FOSR MRI/")
load("data/analysis/bv.rda")
library(refund)
library(caret)
for(i in 3:12){
bv[,i] = log(bv[,i]/bv$icv70)
}
bv$icv70 =  NULL
bv[,c(2:12,15:16)] = scale(bv[,c(2:12,15:16)])
rm(list = setdiff(ls(),c("act_ave","bv")))
act_ave$ID = NULL
act_ave = as.matrix(act_ave)
roi = names(bv)[2:11]
R2 = data.frame()
for(i in 1:10){
roi.i = roi[i]
bv.i = subset(bv, select = c("gender","race","Age","educ_years","CESD",roi.i))
k = 12
dat.ave = bv.i
dat.ave$Y = act_ave
vars = names(dat.ave)[-7]
mod.fld = gls_cs(formula(paste0("Y ~ ", paste(vars, collapse = "+"))), data = dat.ave, basis = "pbs", Kt = k,CI.type = "pointwise")
y = dat.ave$Y
X = cbind(1,as.matrix(dat.ave[,1:6]))
b = mod.fld$beta.hat
yhat = X %*% b
sst = colSums(scale(y, scale = F)^2)
ybar = colMeans(y)
ssre =colSums((yhat - t(replicate(dim(y)[1],ybar)))^2)
R2 = rbind(R2,ssre/sst)
}
par(mfrow = c(3,1))
for(i in 1:6){plot(c(t(R2[,1])), type = "l", ylim = c(0,1))}
par(mfrow = c(3,1))
for(i in 1:6){plot(c(t(R2[,1])), type = "l", ylim = c(0,0.2))}
rm(list = ls())
setwd("~/Dropbox/Junrui Di/BLSA FOSR MRI/")
load("data/analysis/bv.rda")
library(refund)
library(caret)
for(i in 3:12){
bv[,i] = log(bv[,i]/bv$icv70)
}
bv$icv70 =  NULL
bv[,c(2:12,15:16)] = scale(bv[,c(2:12,15:16)])
rm(list = setdiff(ls(),c("act_ave","bv")))
act_ave$ID = NULL
act_ave = as.matrix(act_ave)
roi = names(bv)[2:11]
R2 = data.frame()
for(i in 1:10){
roi.i = roi[i]
bv.i = subset(bv, select = c("gender","race","Age","educ_years","CESD",roi.i))
k = 12
dat.ave = bv.i
dat.ave$Y = act_ave
vars = names(dat.ave)[-7]
mod.fld = gls_cs(formula(paste0("Y ~ ", paste(vars, collapse = "+"))), data = dat.ave, basis = "pbs", Kt = k,CI.type = "pointwise")
y = dat.ave$Y
X = cbind(1,as.matrix(dat.ave[,1:6]))
b = mod.fld$beta.hat
yhat = X %*% b
sst = colSums(scale(y, scale = F)^2)
ybar = colMeans(y)
ssre =colSums((yhat - t(replicate(dim(y)[1],ybar)))^2)
R2 = rbind(R2,ssre/sst)
}
par(mfrow = c(3,1))
for(i in 1:6){plot(c(t(R2[,i])), type = "l", ylim = c(0,0.2))}
xx = c(t(R2))
xx = t(R2)
View(xx)
summary(mod.fld$model.gls)
aa = summary(mod.fld$model.gls)
aa$r.squared
rm(list = ls())
setwd("~/Dropbox/Junrui Di/BLSA FOSR MRI/")
load("data/analysis/bv.rda")
library(refund)
library(caret)
for(i in 3:12){
bv[,i] = log(bv[,i]/bv$icv70)
}
bv$icv70 =  NULL
bv[,c(2:12,15:16)] = scale(bv[,c(2:12,15:16)])
rm(list = setdiff(ls(),c("act_ave","bv")))
act_ave$ID = NULL
act_ave = as.matrix(act_ave)
roi = names(bv)[2:11]
R2 = data.frame()
for(i in 1:10){
roi.i = roi[i]
bv.i = subset(bv, select = c("gender","race","Age","educ_years","CESD",roi.i))
k = 12
dat.ave = bv.i
dat.ave$Y = act_ave
vars = names(dat.ave)[-7]
mod.fld = gls_cs(formula(paste0("Y ~ ", paste(vars, collapse = "+"))), data = dat.ave, basis = "pbs", Kt = k,CI.type = "pointwise")
print(summary(mod.fld$model.gls)$r.squared)
# y = dat.ave$Y
# X = cbind(1,as.matrix(dat.ave[,1:6]))
# b = mod.fld$beta.hat
# yhat = X %*% b
#
# sst = colSums(scale(y, scale = F)^2)
# ybar = colMeans(y)
# ssre =colSums((yhat - t(replicate(dim(y)[1],ybar)))^2)
# R2 = rbind(R2,ssre/sst)
}
y = dat.ave$Y
ybar1 = colMeans(y)
ybar2 = apply(y, 2, mean)
identical(ybar1,ybar2)
names(dat.ave)
a = t(replicate(dim(y)[1],ybar))
ybar = colMeans(y)
a = t(replicate(dim(y)[1],ybar))
dim(a)
View(a)
ssre =colSums((yhat - t(replicate(dim(y)[1],ybar)))^2)
y = dat.ave$Y
X = cbind(1,as.matrix(dat.ave[,1:6]))
b = mod.fld$beta.hat
yhat = X %*% b
sst = colSums(scale(y, scale = F)^2)
ybar = colMeans(y)
ssre =colSums((yhat - t(replicate(dim(y)[1],ybar)))^2)
yy = y - t(replicate(dim(y)[1],ybar))
ssto = apply(yy2,2,sum)
yy = y - t(replicate(dim(y)[1],ybar))
ssto = apply(yy^2,2,sum)
identical(sst,ssto)
rm(list = ls())
setwd("~/Dropbox/Junrui Di/BLSA FOSR MRI/")
load("data/analysis/bv.rda")
library(refund)
library(caret)
for(i in 3:12){
bv[,i] = log(bv[,i]/bv$icv70)
}
bv$icv70 =  NULL
bv[,c(2:12,15:16)] = scale(bv[,c(2:12,15:16)])
rm(list = setdiff(ls(),c("act_ave","bv")))
act_ave$ID = NULL
act_ave = as.matrix(act_ave)
roi = names(bv)[2:11]
R2 = data.frame()
i = 5
roi.i = roi[i]
bv.i = subset(bv, select = c("gender","race","Age","educ_years","CESD",roi.i))
k = 12
dat.ave = bv.i
dat.ave$Y = act_ave
vars = names(dat.ave)[-7]
names(dat.ave)
mod.fld = gls_cs(formula(paste0("Y ~ ", paste(vars, collapse = "+"))), data = dat.ave, basis = "pbs", Kt = k,CI.type = "pointwise")
print(summary(mod.fld$model.gls)$r.squared)
y = dat.ave$Y
X = cbind(1,as.matrix(dat.ave[,1:6]))
b = mod.fld$beta.hat
yhat = X %*% b
sst = colSums(scale(y, scale = F)^2)
ybar = colMeans(y)
ssre =colSums((yhat - t(replicate(dim(y)[1],ybar)))^2)
r2 = ssre/sst
par(mfrow = c(1,1))
plot(r2)
i = 1
roi.i = roi[i]
bv.i = subset(bv, select = c("gender","race","Age","educ_years","CESD",roi.i))
k = 12
dat.ave = bv.i
dat.ave$Y = act_ave
vars = names(dat.ave)[-7]
mod.fld = gls_cs(formula(paste0("Y ~ ", paste(vars, collapse = "+"))), data = dat.ave, basis = "pbs", Kt = k,CI.type = "pointwise")
print(summary(mod.fld$model.gls)$r.squared)
y = dat.ave$Y
X = cbind(1,as.matrix(dat.ave[,1:6]))
b = mod.fld$beta.hat
yhat = X %*% b
sst = colSums(scale(y, scale = F)^2)
ybar = colMeans(y)
ssre =colSums((yhat - t(replicate(dim(y)[1],ybar)))^2)
plot(ssre/sst)
i= 2
roi.i = roi[i]
bv.i = subset(bv, select = c("gender","race","Age","educ_years","CESD",roi.i))
k = 12
dat.ave = bv.i
dat.ave$Y = act_ave
vars = names(dat.ave)[-7]
mod.fld = gls_cs(formula(paste0("Y ~ ", paste(vars, collapse = "+"))), data = dat.ave, basis = "pbs", Kt = k,CI.type = "pointwise")
print(summary(mod.fld$model.gls)$r.squared)
y = dat.ave$Y
X = cbind(1,as.matrix(dat.ave[,1:6]))
b = mod.fld$beta.hat
yhat = X %*% b
sst = colSums(scale(y, scale = F)^2)
ybar = colMeans(y)
ssre =colSums((yhat - t(replicate(dim(y)[1],ybar)))^2)
plot(ssre/sst)
i = 3
roi.i = roi[i]
bv.i = subset(bv, select = c("gender","race","Age","educ_years","CESD",roi.i))
k = 12
dat.ave = bv.i
dat.ave$Y = act_ave
vars = names(dat.ave)[-7]
mod.fld = gls_cs(formula(paste0("Y ~ ", paste(vars, collapse = "+"))), data = dat.ave, basis = "pbs", Kt = k,CI.type = "pointwise")
print(summary(mod.fld$model.gls)$r.squared)
y = dat.ave$Y
X = cbind(1,as.matrix(dat.ave[,1:6]))
b = mod.fld$beta.hat
yhat = X %*% b
sst = colSums(scale(y, scale = F)^2)
ybar = colMeans(y)
ssre =colSums((yhat - t(replicate(dim(y)[1],ybar)))^2)
plot(ssre/sst)
pdf(file = "~/Desktop/check.pdf", width = 10,height = 25)
par(mfrow = c(5,1))
R2 = data.frame()
for(i in 1:10){
roi.i = roi[i]
bv.i = subset(bv, select = c("gender","race","Age","educ_years","CESD",roi.i))
k = 12
dat.ave = bv.i
dat.ave$Y = act_ave
vars = names(dat.ave)[-7]
mod.fld = gls_cs(formula(paste0("Y ~ ", paste(vars, collapse = "+"))), data = dat.ave, basis = "pbs", Kt = k,CI.type = "pointwise")
print(summary(mod.fld$model.gls)$r.squared)
y = dat.ave$Y
X = cbind(1,as.matrix(dat.ave[,1:6]))
b = mod.fld$beta.hat
yhat = X %*% b
sst = colSums(scale(y, scale = F)^2)
ybar = colMeans(y)
ssre =colSums((yhat - t(replicate(dim(y)[1],ybar)))^2)
plot(ssre/sst)
R2 = rbind(R2,ssre/sst)
}
dev.off()
rm(list = ls())
setwd("~/Dropbox/Junrui Di/BLSA FOSR MRI/")
load("data/analysis/bv.rda")
library(refund)
library(caret)
for(i in 3:12){
bv[,i] = log(bv[,i]/bv$icv70)
}
bv$icv70 =  NULL
bv[,c(2:12,15:16)] = scale(bv[,c(2:12,15:16)])
rm(list = setdiff(ls(),c("act_ave","bv")))
act_ave$ID = NULL
act_ave = as.matrix(act_ave)
roi = names(bv)[2:11]
pdf(file = "~/Desktop/check.pdf", width = 10,height = 25)
par(mfrow = c(5,1))
R2 = data.frame()
for(i in 1:10){
roi.i = roi[i]
bv.i = subset(bv, select = c("gender","race","Age","educ_years","CESD",roi.i))
dat.ave = bv.i
dat.ave$Y = act_ave
vars = names(dat.ave)[-7]
for(k in c(6,8,10,12,14)){
mod.fld = gls_cs(formula(paste0("Y ~ ", paste(vars, collapse = "+"))), data = dat.ave, basis = "pbs", Kt = k,CI.type = "pointwise")
print(summary(mod.fld$model.gls)$r.squared)
y = dat.ave$Y
# X = cbind(1,as.matrix(dat.ave[,1:6]))
# b = mod.fld$beta.hat
# yhat = X %*% b
yhat = mod.fld$Yhat
sst = colSums(scale(y, scale = F)^2)
ybar = colMeans(y)
ssre =colSums((yhat - t(replicate(dim(y)[1],ybar)))^2)
plot(ssre/sst, main = paste0(roi.i,"  ", k), ylim = c(0,1), type = "l")
}
}
dev.off()
rm(list = ls())
setwd("~/Dropbox/Junrui Di/BLSA FOSR MRI/")
load("data/analysis/bv.rda")
library(refund)
library(caret)
for(i in 3:12){
bv[,i] = log(bv[,i]/bv$icv70)
}
bv$icv70 =  NULL
bv[,c(2:12,15:16)] = scale(bv[,c(2:12,15:16)])
rm(list = setdiff(ls(),c("act_ave","bv")))
act_ave$ID = NULL
act_ave = as.matrix(act_ave)
roi = names(bv)[2:11]
pdf(file = "~/Desktop/check.pdf", width = 10,height = 25)
par(mfrow = c(5,1))
R2 = data.frame()
for(i in 1:10){
roi.i = roi[i]
bv.i = subset(bv, select = c("gender","race","Age","educ_years","CESD",roi.i))
dat.ave = bv.i
dat.ave$Y = act_ave
vars = names(dat.ave)[-7]
for(k in c(6,8,10,12,14)){
mod.fld = gls_cs(formula(paste0("Y ~ ", paste(vars, collapse = "+"))), data = dat.ave, basis = "pbs", Kt = k,CI.type = "pointwise")
print(summary(mod.fld$model.gls)$r.squared)
y = mod.fld$data$Y
yhat = mod.fld$Yhat
sst = colSums(scale(y, scale = F)^2)
ybar = colMeans(y)
ssre =colSums((yhat - t(replicate(dim(y)[1],ybar)))^2)
plot(ssre/sst, main = paste0(roi.i,"  ", k), ylim = c(0,1), type = "l")
}
}
dev.off()
rm(list = ls())
setwd("D:/Dropbox/Junrui Di/BLSA FOSR MRI/")
load("data/analysis/bv_apoe.rda")
source("scripts/fosr_interact.R")
library(refund)
for(i in 3:12){
bv[,i] = log(bv[,i]/bv$icv70)
}
bv$icv70 = NULL
bv[,c(2:12,15:16)] = scale(bv[,c(2:12,15:16)])
rm(list = setdiff(ls(),c("act_ave","bv","fosr_interact")))
act_ave$ID = NULL
act_ave = as.matrix(act_ave)
rm(list = ls())
setwd("~/Dropbox/Junrui Di/BLSA FOSR MRI/")
load("data/analysis/bv_apoe.rda")
source("scripts/fosr_interact.R")
library(refund)
for(i in 3:12){
bv[,i] = log(bv[,i]/bv$icv70)
}
bv$icv70 = NULL
bv[,c(2:12,15:16)] = scale(bv[,c(2:12,15:16)])
rm(list = setdiff(ls(),c("act_ave","bv","fosr_interact")))
act_ave$ID = NULL
act_ave = as.matrix(act_ave)
roi = names(bv)[2:11]
interaction_effect = data.frame(regions = roi, f.p = NA)
fosr_ave = list()
i = 1
roi.i = roi[i]
bv.i = subset(bv, select = c("gender","race","Age","educ_years","CESD","ap1",roi.i))
print(i)
##########################################################################################################################
# ave
dat.ave = bv.i
dat.ave$Y = act_ave
names(dat.ave)
i = 5
roi.i = roi[i]
bv.i = subset(bv, select = c("gender","race","Age","educ_years","CESD","ap1",roi.i))
print(i)
##########################################################################################################################
# ave
dat.ave = bv.i
dat.ave$Y = act_ave
names(dat.ave)
vars = names(dat.ave)[-8]
var.cur.ind = which(vars == roi.i)
vars
var.cur.ind
formula(paste0("Y ~ ", paste(vars, collapse = "+")))
formula(paste0("Y ~ ", paste(vars, collapse = "+"), paste0(" + ap1 * ", vars[var.cur.ind])))
fit.null = bayes_fosr(formula(paste0("Y ~ ", paste(vars, collapse = "+"))),
est.method = "GLS", Kt = 8, data = dat.ave, basis = "pbs", CI.type = "pointwise", verbose = FALSE)
fit.alt = bayes_fosr(formula(paste0("Y ~ ", paste(vars, collapse = "+"), paste0(" + ap1 * ", vars[var.cur.ind]))),
est.method = "GLS", Kt = 8, data = dat.ave, basis = "pbs", CI.type = "pointwise", verbose = FALSE,
sigma = fit.null$sigma)
anova(fit.null$model.gls, fit.alt$model.gls)$P[2]
anova(fit.alt$model.gls, fit.null$model.gls)$P[2]
# 1.3 model fittingp
model.gls.pw.ave = gls_cs(formula(paste0("Y ~ ", paste(vars, collapse = "+"), paste0(" + ap1 * ", vars[var.cur.ind]))), data = dat.ave, basis = "pbs", Kt = 8,CI.type = "pointwise")
model.gls.st.ave = gls_cs(formula(paste0("Y ~ ", paste(vars, collapse = "+"), paste0(" + ap1 * ", vars[var.cur.ind]))), data = dat.ave, basis = "pbs", Kt = 8,CI.type = "simultaneous")
var.cur.ind
formula(paste0("Y ~ ", paste(vars, collapse = "+"), paste0(" + ap1 * ", vars[var.cur.ind])))
int_pw = fosr_interact(obj = model.gls.pw.ave, p1 = var.cur.ind + 1, p2 = var.cur.ind + 2, Kt = 8, CI.type = "pointwise")
int_st = fosr_interact(obj = model.gls.st.ave, p1 = var.cur.ind + 1, p2 = var.cur.ind + 2, Kt = 8, CI.type = "simultaneous")
View(int_pw)
gls_cs
obj = model.gls.pw.ave
p1 = 8
p2 = 9
Kt = 8
D  = dim(obj$Yhat)[2]
a1 = Kt * p1 - (Kt - 1)
b1 = Kt * p1
a2 = Kt * p2 - (Kt - 1)
b2 = Kt * p2
a1
b1
dim(obj$beta.hat)
beta.hat = obj$beta.hat[p1,] + obj$beta.hat[p2,]
Theta = pbs::pbs(1:D, df = Kt, intercept = TRUE, degree = 3)
cov = vcov(obj$model.gls)
cov.cur = Theta %*% cov[a1:b1, a1:b1] %*% t(Theta) + Theta %*% cov[a2:b2, a2:b2] %*% t(Theta) +
Theta %*% cov[a1:b1, a2:b2] %*% t(Theta) +  Theta %*% cov[a2:b2, a1:b1] %*% t(Theta)
isSymmetric(cov.cur)
56/8
p1
Kt
p1
var.cur.ind + 1
xxx =model.gls.pw.ave$beta.hat
View(cov)
p1
Kt * p1
a1 = Kt * p1 - (Kt - 1)
b1 = Kt * p1
a2 = Kt * p2 - (Kt - 1)
b2 = Kt * p2
a2
b2
#Set our working directory.
#This helps avoid confusion if our working directory is
#not our site because of other projects we were
#working on at the time.
setwd("~/Dropbox/web/junruidi.github.io/")
#render your sweet site.
rmarkdown::render_site()
# git add -A
# git commit -m "2nd commit"
# git push origin master
